# GitHub action file for SwanHub SDK
name: SwanHub SDK Application Workflow

# Triggers the workflow on push or pull request
on:
  push: # Triggered on a push to any branch ( do not change )
  schedule:
    # Run workflow at 4 AM EST (9 AM UTC)
    - cron: '0 9 * * *'
    # Run workflow at 7 PM EST (12 AM UTC next day)
    - cron: '0 0 * * *'
  release:
    types: [ created ] # Triggers the workflow when a release is created.

# Defines the jobs that the workflow will execute
jobs:
  # Combined job for lint, test, build, and deploy
  PR:
    runs-on: ubuntu-latest
    env:
      USE_VENV: ${{ secrets.USE_VENV }}  # Contributors set this in their repository secrets
    if: github.event_name == 'push' || github.event_name == 'pull_request' || (github.event_name == 'release' && github.event.action == 'created')
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (global)
        if: env.USE_VENV != 'true'
        run: |
          pip install black pytest twine
          pip install -r requirements.txt

      - name: Activate virtual environment
        if: env.USE_VENV == 'true'
        run: source ./venv/bin/activate

      - name: Install dependencies (virtual environment)
        if: env.USE_VENV == 'true'
        run: |
          pip install black pytest twine
          pip install -r requirements.txt

      - name: Lint with Black
        run: |
          black --check ./**/*.py

      - name: Run tests
        run: pytest

      - name: Build the project
        run: |
          python setup.py sdist bdist_wheel

      - name: Publish to PyPI
        if: github.event_name == 'release' && github.event.action == 'created'
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
        run: |
          twine upload dist/*
  
# UNCOMMENT ONLY AFTER PM DECISION
#  # Database setup job
#  setup-database:
#    runs-on: ubuntu-latest
#    services: # Define the PostgreSQL service
#      postgres:
#        image: postgres:latest
#        env:
#          POSTGRES_DB: test_db  # Database name
#          POSTGRES_USER: test_user  # Desired username
#          POSTGRES_PASSWORD: test_password  # Desired password
#        ports:
#          - 5432:5432
#    steps:
#      - name: Wait for PostgreSQL to start
#        run: |
#          for i in {1..30}; do
#            nc -z localhost 5432 && break
#            sleep 1
#          done
#          sleep 10
#
#      - name: Install Python Dependencies
#        run: |
#          sudo apt-get -y install python3-pip
#          pip install --upgrade pip
#
#      - name: Database Setup Steps
#        run: |
#          python setup_database.py
#        # Create a setup_database.py file and run it here

# Permissions setup for the workflow
permissions:
    contents: read # Grants read access to the repository contents
    pull-requests: write # Grants write access to pull requests
    issues: write # Grants write access to issues (optional)
    actions: read # Grants read access to other GitHub Actions workflows (optional)

